# Set the number of worker processes
worker_processes ${{NUM_WORKERS}};

# Configure error log output to stderr with notice level
error_log stderr notice;

# Run nginx in foreground (don't daemonize)
daemon off;

# Set the path for the nginx process ID file
pid logs/nginx.pid;

# Event processing configuration block
events {
  # Maximum number of simultaneous connections per worker
  worker_connections 1024;
}

# HTTP server configuration block
http {

  # Include MIME type definitions
  include mime.types;

  # Set client request body temporary files location
  client_body_temp_path logs/client_body_temp;

  # Set FastCGI temporary files location
  fastcgi_temp_path logs/fastcgi_temp;

  # Set proxy temporary files location
  proxy_temp_path logs/proxy_temp;

  # Set SCGI temporary files location
  scgi_temp_path logs/scgi_temp;

  # Set uWSGI temporary files location
  uwsgi_temp_path logs/uwsgi_temp;

  # Initialize Lua modules when nginx starts
  init_by_lua_block {
    local lpeg = require("lpeg")
    local lfs = require("lfs")
    _G.System = {}
  }

  # Virtual server configuration block
  server {
    # Set the port to listen on
    listen ${{PORT}};

    # Enable or disable Lua code caching
    lua_code_cache ${{CODE_CACHE}};

    # Handle root path requests
    location / {
      # Set default response content type
      default_type text/html;

      # Execute Lua code to serve Lapis application
      content_by_lua_block {
        require("lapis").serve("app")
      }
    }

    # Serve static files from /static/ URL path
    location /static/ {
      alias static/;
    }

    # Handle favicon.ico requests specifically
    location /favicon.ico {
      alias static/favicon.ico;
    }
  }
}